select
ROW_NUMBER() OVER (ORDER BY SORT_SEIKYUU_DATE) as ROW_NUMBER
,inview.TORIHIKISAKI_CD
,inview.TORIHIKISAKI_NAME_RYAKU
,inview.EIGYOU_TANTOU_CD
,inview.EIGYOU_TANTOUSYA_NAME
,inview.SEIKYUU_DATE
,inview.SORT_SEIKYUU_DATE
,inview.SEIKYUU_NUMBER
,inview.SEIKYUU_KINGAKU
,NULL SYSTEM_ID
,'' KESHIKOMI_BIKOU
,inview.KESHIKOMI_GAKU
 from
 (SELECT
	B.TORIHIKISAKI_CD,
	B.TORIHIKISAKI_NAME_RYAKU,
	B.EIGYOU_TANTOU_CD,
	E.EIGYOU_TANTOUSYA_NAME,
	'開始残高' as SEIKYUU_DATE,
	'1753-01-01 00:00:00.000' as SORT_SEIKYUU_DATE,
	A.SEIKYUU_NUMBER as SEIKYUU_NUMBER,
	(A.KAISHI_URIKAKE_ZANDAKA - ISNULL(c.KESHIKOMI_GAKU,0)) as SEIKYUU_KINGAKU,
	c.KESHIKOMI_GAKU as KESHIKOMI_GAKU
FROM
	(Select
	0 as SEIKYUU_NUMBER,
	TORIHIKISAKI_SEIKYUU.TORIHIKISAKI_CD as TORIHIKISAKI_CD,
	TORIHIKISAKI_SEIKYUU.KAISHI_URIKAKE_ZANDAKA
	FROM
	M_TORIHIKISAKI_SEIKYUU TORIHIKISAKI_SEIKYUU
	WHERE
	/*IF nyuukinsakiCd != null && nyuukinsakiCd != ''*/
	TORIHIKISAKI_SEIKYUU.NYUUKINSAKI_CD = /*nyuukinsakiCd*//*END*/
	) as A
	 LEFT JOIN
	(SELECT
	 SUM(NYUUKIN_KESHIKOMI.KESHIKOMI_GAKU) as KESHIKOMI_GAKU,
	 NYUUKIN_KESHIKOMI.SEIKYUU_NUMBER,
	 NYUUKIN_KESHIKOMI.TORIHIKISAKI_CD
	 FROM
	 T_NYUUKIN_ENTRY NYUUKIN LEFT JOIN T_NYUUKIN_KESHIKOMI NYUUKIN_KESHIKOMI ON NYUUKIN.SYSTEM_ID = NYUUKIN_KESHIKOMI.SYSTEM_ID AND NYUUKIN.DELETE_FLG = 0 AND NYUUKIN_KESHIKOMI.DELETE_FLG = 0
	 WHERE
	 NYUUKIN_KESHIKOMI.SEIKYUU_NUMBER = 0
 	 AND NYUUKIN.TORIHIKISAKI_CD = NYUUKIN_KESHIKOMI.TORIHIKISAKI_CD
     /*IF nyuukinsakiCd != null && nyuukinsakiCd != ''*/
	 AND NYUUKIN.NYUUKINSAKI_CD = /*nyuukinsakiCd*//*END*/
	 GROUP BY
	 NYUUKIN_KESHIKOMI.SEIKYUU_NUMBER,NYUUKIN_KESHIKOMI.TORIHIKISAKI_CD
	 ) as C ON A.SEIKYUU_NUMBER = C.SEIKYUU_NUMBER AND A.TORIHIKISAKI_CD = C.TORIHIKISAKI_CD,
	M_TORIHIKISAKI as B
	LEFT JOIN
	(SELECT
	 SHAIN.SHAIN_NAME_RYAKU as EIGYOU_TANTOUSYA_NAME,
	 SHAIN.SHAIN_CD as SHAIN_CD
	 FROM
	 M_SHAIN SHAIN
	 WHERE
	 SHAIN.DELETE_FLG = 0) as E ON B.EIGYOU_TANTOU_CD = E.SHAIN_CD
	WHERE
	B.DELETE_FLG = 0
	AND B.TORIHIKISAKI_CD = A.TORIHIKISAKI_CD
	/*IF denpyouDate != null && denpyouDate != ''*/
	AND	isnull(B.TEKIYOU_BEGIN,'1900-01-01 00:00:00.000') <= /*denpyouDate*/
	AND	isnull(B.TEKIYOU_END,'2099-01-01 00:00:00.000') >= /*denpyouDate*//*END*/
UNION
SELECT
	D.TORIHIKISAKI_CD,
	D.TORIHIKISAKI_NAME_RYAKU,
	D.EIGYOU_TANTOU_CD,
	E.EIGYOU_TANTOUSYA_NAME,
	CONVERT(varchar(10), A.SEIKYUU_DATE, 20) as SEIKYU_DATE,
	A.SEIKYUU_DATE as SORT_SEIKYU_DATE,
	A.SEIKYUU_NUMBER as SEIKYUU_NUMBER,
    (A.KONKAI_URIAGE_GAKU + A.KONKAI_SEI_UTIZEI_GAKU + A.KONKAI_SEI_SOTOZEI_GAKU + A.KONKAI_DEN_UTIZEI_GAKU + A.KONKAI_DEN_SOTOZEI_GAKU + A.KONKAI_MEI_UTIZEI_GAKU + A.KONKAI_MEI_SOTOZEI_GAKU - ISNULL(B.KESHIKOMI_GAKU, 0) ) AS SEIKYUU_KINGAKU,
	B.KESHIKOMI_GAKU AS KESHIKOMI_GAKU
FROM
	T_SEIKYUU_DENPYOU as A
	LEFT JOIN
	(SELECT
	 SUM(NYUUKIN_KESHIKOMI.KESHIKOMI_GAKU) as KESHIKOMI_GAKU,
	 NYUUKIN_KESHIKOMI.SEIKYUU_NUMBER,
	 NYUUKIN_KESHIKOMI.TORIHIKISAKI_CD
	 FROM
	 T_NYUUKIN_ENTRY NYUUKIN LEFT JOIN T_NYUUKIN_KESHIKOMI NYUUKIN_KESHIKOMI ON NYUUKIN.SYSTEM_ID = NYUUKIN_KESHIKOMI.SYSTEM_ID AND NYUUKIN.DELETE_FLG = 0 AND NYUUKIN_KESHIKOMI.DELETE_FLG = 0
	                         LEFT JOIN T_SEIKYUU_DENPYOU SEIKYUU_DENPYOU ON NYUUKIN_KESHIKOMI.SEIKYUU_NUMBER = SEIKYUU_DENPYOU.SEIKYUU_NUMBER AND SEIKYUU_DENPYOU.DELETE_FLG = 0
	 WHERE
	 SEIKYUU_DENPYOU.TORIHIKISAKI_CD = NYUUKIN_KESHIKOMI.TORIHIKISAKI_CD
	 /*IF denpyouDate != null && denpyouDate != ''*/
	 AND SEIKYUU_DENPYOU.SEIKYUU_DATE <= /*denpyouDate*//*END*/
	 GROUP BY
	 NYUUKIN_KESHIKOMI.SEIKYUU_NUMBER,NYUUKIN_KESHIKOMI.TORIHIKISAKI_CD
	 ) as B ON A.SEIKYUU_NUMBER = B.SEIKYUU_NUMBER AND A.TORIHIKISAKI_CD = B.TORIHIKISAKI_CD
	LEFT JOIN
	(SELECT A.SEIKYUU_NUMBER, SUM(A.KINGAKU) AS NYUUKIN_KINGAKU FROM T_SEIKYUU_DETAIL AS A LEFT JOIN T_NYUUKIN_KESHIKOMI AS B ON A.DENPYOU_NUMBER = B.NYUUKIN_NUMBER AND B.DELETE_FLG = 0 WHERE A.DENPYOU_SHURUI_CD = 10 AND A.DELETE_FLG = 0 AND B.SEIKYUU_NUMBER IS NULL GROUP BY A.SEIKYUU_NUMBER) AS F ON F.SEIKYUU_NUMBER = A.SEIKYUU_NUMBER,
	M_TORIHIKISAKI_SEIKYUU as C,
	M_TORIHIKISAKI as D
	LEFT JOIN
	(SELECT
	 SHAIN.SHAIN_NAME_RYAKU as EIGYOU_TANTOUSYA_NAME,
	 SHAIN.SHAIN_CD as SHAIN_CD
	 FROM
	 M_SHAIN SHAIN
	 WHERE
	 SHAIN.DELETE_FLG = 0) as E ON D.EIGYOU_TANTOU_CD = E.SHAIN_CD
	WHERE
	/*IF nyuukinsakiCd != null && nyuukinsakiCd != ''*/
	C.NYUUKINSAKI_CD = /*nyuukinsakiCd*//*END*/
	AND C.TORIHIKISAKI_CD = A.TORIHIKISAKI_CD
	/*IF denpyouDate != null && denpyouDate != ''*/
	AND A.SEIKYUU_DATE <= /*denpyouDate*//*END*/
	AND A.DELETE_FLG = 0
	/*IF denpyouDate != null && denpyouDate != ''*/
	AND D.DELETE_FLG = 0
	AND D.TORIHIKISAKI_CD = C.TORIHIKISAKI_CD
	AND	isnull(D.TEKIYOU_BEGIN,'1900-01-01 00:00:00.000') <= /*denpyouDate*/
	AND	isnull(D.TEKIYOU_END,'2099-01-01 00:00:00.000') >= /*denpyouDate*//*END*/
	AND D.DELETE_FLG = 0
) inview
/*IF sort == 2*/
 order by TORIHIKISAKI_CD,SEIKYUU_NUMBER/*END*/
 /*IF sort == 1*/
 order by SORT_SEIKYUU_DATE/*END*/