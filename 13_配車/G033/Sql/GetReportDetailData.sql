--収集Start
SELECT TUSSE.SAGYOU_DATE               AS SAGYOU_DATE,--作業日,
       CONVERT(char(8),TUSSE.SAGYOU_DATE,112) AS SORT_SAGYOU_DATE,--作業日(並び用),
       TUSSE.UNTENSHA_CD                 , --運転者CD,
       TUSSE.UNTENSHA_NAME                   AS UNTENSHA, --運転者,
	   '1'                                AS SYUBETUCD,--識別詞CD,
	   '収集'                                AS SYUBETU,--識別詞,
	   MMS.MANIFEST_SHURUI_NAME,--マニ情報,
	   MMT.MANIFEST_TEHAI_NAME,--マニ手配,
	   TUSSE.UKETSUKE_NUMBER,--受付番号,
	   TUSSE.GENCHAKU_TIME_NAME,--現着時間名,
	   TUSSE.GENCHAKU_TIME,--現着時間,
	   TUSSE.SAGYOU_TIME,--作業時間,
	   TUSSE.GYOUSHA_CD,--業者CD,
	   TUSSE.GYOUSHA_NAME,--業者名,
	   TUSSE.SHASHU_CD,--車種CD,
	   TUSSE.SHASHU_NAME,--車種名,
	   TUSSE.SHARYOU_CD,--車輌CD,
	   TUSSE.SHARYOU_NAME,--車輌名,
	   TUSSE.GENBA_CD,--現場CD,
	   TUSSE.GENBA_NAME,--現場名,
	   TUSSE.NIOROSHI_GENBA_CD AS NIOROSHI_NIZUMI_CD,--荷降先・荷積先CD,
	   TUSSE.NIOROSHI_GENBA_NAME AS NIOROSHI_NIZUMI_NAME,--荷降先・荷積先,
	   MG1.GENBA_ADDRESS1 + NCHAR(13) + NCHAR(10) + MG1.GENBA_ADDRESS2 AS GENBA_ADDRESS,--現場住所,
	   MG2.GENBA_ADDRESS1 + NCHAR(13) + NCHAR(10) + MG2.GENBA_ADDRESS2 AS NIOROSHI_NIZUMI_ADDRESS,--荷降先・荷積先住所,
	   TUSSE.GENBA_TEL,--現場電話番号,
	   TUSSE.TANTOSHA_NAME AS TANTOUSHA,--担当者名,
	   TUSSE.TANTOSHA_TEL AS GENBA_KEITAI_TEL ,--担当者携帯番号,
	   TUSSE.UKETSUKE_BIKOU1,--受付備考１
	   TUSSE.UKETSUKE_BIKOU2,--受付備考２
	   TUSSE.UKETSUKE_BIKOU3,--受付備考３
	   TUSSE.UNTENSHA_SIJIJIKOU1,--運転者指示事項１
	   TUSSE.UNTENSHA_SIJIJIKOU2,--運転者指示事項２
	   TUSSE.UNTENSHA_SIJIJIKOU3,--運転者指示事項３
	   TUSSD_TCR.CONTENA_SHURUI_CD,--コンテナ種類CD,
	   MCS.CONTENA_SHURUI_NAME_RYAKU AS CONTENA_SHURUI_NAME,--コンテナ種類,
	   CASE WHEN TUSSD_TCR.CONTENA_SET_KBN = 1 
	        THEN '設置'
	        WHEN TUSSD_TCR.CONTENA_SET_KBN = 2 
			THEN '引揚'
			ELSE '' END                      AS CONTENA_JOUKYOU_NAME,--設置・引揚,
	   TUSSD_TCR.DAISUU_CNT AS DAISUU,--台数,
	   TUSSD_TCR.HINMEI_CD,--品名CD,
	   TUSSD_TCR.HINMEI_NAME,--品名,
	   TUSSD_TCR.SUURYOU,--数量,
	   MU.UNIT_NAME_RYAKU AS UNIT_NAME--単位

FROM T_UKETSUKE_SS_ENTRY AS TUSSE                                                 --受付（収集）入力テーブル
     LEFT JOIN M_MANIFEST_SHURUI AS MMS                                           --マニフェスト種類マスタ
         ON TUSSE.MANIFEST_SHURUI_CD = MMS.MANIFEST_SHURUI_CD
	 LEFT JOIN M_MANIFEST_TEHAI  AS MMT                                           --マニフェスト手配
	     ON TUSSE.MANIFEST_TEHAI_CD = MMT.MANIFEST_TEHAI_CD
	 LEFT JOIN M_GENBA AS MG1                                                     --現場マスタ 現場住所
	     ON TUSSE.GENBA_CD = MG1.GENBA_CD AND TUSSE.GYOUSHA_CD = MG1.GYOUSHA_CD
     LEFT JOIN M_GENBA AS MG2                                                     --現場マスタ 荷降先住所
	     ON TUSSE.NIOROSHI_GYOUSHA_CD = MG2.GYOUSHA_CD AND TUSSE.NIOROSHI_GENBA_CD  = MG2.GENBA_CD
     LEFT JOIN
		(SELECT TUSSD.SYSTEM_ID ID1,TUSSD.SEQ SEQ1,TUSSD.HINMEI_CD,TUSSD.HINMEI_NAME,TUSSD.SUURYOU,TUSSD.UNIT_CD,
			      TUSSD.SYSTEM_ID ID2,  TUSSD.SEQ SEQ2,TUSSD.CONTENA_SHURUI_CD,TUSSD.CONTENA_SET_KBN,TUSSD.DAISUU_CNT
		 FROM
		  (SELECT  ROW_NUMBER() OVER (PARTITION BY SYSTEM_ID,SEQ ORDER BY DETAIL_SYSTEM_ID) RANK
		        , SYSTEM_ID, SEQ, SYSTEM_ID ID1,SEQ SEQ1,HINMEI_CD,HINMEI_NAME,SUURYOU,UNIT_CD
				,NULL as ID2, NULL as SEQ2, NULL AS CONTENA_SHURUI_CD, NULL AS CONTENA_SET_KBN, NULL as DAISUU_CNT
		   FROM T_UKETSUKE_SS_DETAIL
           UNION ALL
           SELECT  ROW_NUMBER() OVER (PARTITION BY SYSTEM_ID,SEQ ORDER BY CONTENA_SET_KBN) RANK
		         ,NULL as ID1, NULL as SEQ1, NULL as HINMEI_CD, NULL AS HINMEI_NAME, NULL AS SUURYOU, NULL AS UNIT_CD
		         ,SYSTEM_ID,SEQ, SYSTEM_ID ID2,SEQ SEQ2,CONTENA_SHURUI_CD,CONTENA_SET_KBN,DAISUU_CNT 
		   FROM
		    (SELECT SYSTEM_ID,SEQ,CONTENA_SET_KBN,CONTENA_SHURUI_CD,SUM(DAISUU_CNT) DAISUU_CNT
			 FROM T_CONTENA_RESERVE	WHERE DELETE_FLG = 0
		 	GROUP BY SYSTEM_ID,SEQ,CONTENA_SET_KBN,CONTENA_SHURUI_CD) AS W

		   ) AS TUSSD) AS TUSSD_TCR

     ON TUSSE.SYSTEM_ID = (CASE WHEN TUSSD_TCR.ID1 IS NULL THEN TUSSD_TCR.ID2 ELSE TUSSD_TCR.ID1 END)
	    AND TUSSE.SEQ = (CASE WHEN TUSSD_TCR.SEQ1 IS NULL THEN TUSSD_TCR.SEQ2 ELSE TUSSD_TCR.SEQ1 END)
	 LEFT JOIN M_CONTENA_SHURUI AS MCS                                            --コンテナ種類マスタ
	     ON TUSSD_TCR.CONTENA_SHURUI_CD = MCS.CONTENA_SHURUI_CD
	 LEFT JOIN M_UNIT AS MU                                                       --単位マスタ
	     ON TUSSD_TCR.UNIT_CD = MU.UNIT_CD
WHERE TUSSE.DELETE_FLG = 0
      AND TUSSE.SAGYOU_DATE >= /*data.kikanFrom*/
      AND TUSSE.SAGYOU_DATE <= /*data.kikanTo*/
	  AND TUSSE.UNTENSHA_CD >= /*data.untenshaFrom*/
      AND TUSSE.UNTENSHA_CD <= /*data.untenshaTo*/

--収集End

UNION ALL

--出荷Start
SELECT TUSKE.SAGYOU_DATE               AS SAGYOU_DATE,--作業日,
       CONVERT(char(8),TUSKE.SAGYOU_DATE,112)   AS SORT_SAGYOU_DATE,--作業日(並び用),
       TUSKE.UNTENSHA_CD                 , --運転者CD,
       TUSKE.UNTENSHA_NAME                   AS UNTENSHA,--運転者,
	   '2'                                AS SYUBETUCD,--識別詞CD,
	   '出荷'                                AS SYUBETU,--識別詞,
	   MMS.MANIFEST_SHURUI_NAME,--マニ情報,
	   MMT.MANIFEST_TEHAI_NAME,--マニ手配,
	   TUSKE.UKETSUKE_NUMBER,--受付番号,
	   TUSKE.GENCHAKU_TIME_NAME,--現着時間名,
	   TUSKE.GENCHAKU_TIME,--現着時間,
	   TUSKE.SAGYOU_TIME,--作業時間,
	   TUSKE.GYOUSHA_CD,--業者CD,
	   TUSKE.GYOUSHA_NAME,--業者名,
	   TUSKE.SHASHU_CD,--車種CD,
	   TUSKE.SHASHU_NAME,--車種名,
	   TUSKE.SHARYOU_CD,--車輌CD,
	   TUSKE.SHARYOU_NAME,--車輌名,
	   TUSKE.GENBA_CD,--現場CD,
	   TUSKE.GENBA_NAME,--現場名,
	   TUSKE.NIZUMI_GENBA_CD AS NIOROSHI_NIZUMI_CD,--荷降先・荷積先CD,
	   TUSKE.NIZUMI_GENBA_NAME AS NIOROSHI_NIZUMI_NAME,--荷降先・荷積先,
	   MG1.GENBA_ADDRESS1 + NCHAR(13) + NCHAR(10) + MG1.GENBA_ADDRESS2 AS GENBA_ADDRESS,--現場住所,
	   MG2.GENBA_ADDRESS1 + NCHAR(13) + NCHAR(10) + MG2.GENBA_ADDRESS2 AS NIOROSHI_NIZUMI_ADDRESS,--荷降先・荷積先住所,
	   TUSKE.GENBA_TEL,--現場電話番号,
	   TUSKE.TANTOSHA_NAME AS TANTOUSHA,--担当者名,
	   TUSKE.TANTOSHA_TEL AS GENBA_KEITAI_TEL,--担当者携帯番号,
	   TUSKE.UKETSUKE_BIKOU1,--受付備考１
	   TUSKE.UKETSUKE_BIKOU2,--受付備考２ 
	   TUSKE.UKETSUKE_BIKOU3,--受付備考３
	   TUSKE.UNTENSHA_SIJIJIKOU1,--運転者指示事項１
	   TUSKE.UNTENSHA_SIJIJIKOU2,--運転者指示事項２
	   TUSKE.UNTENSHA_SIJIJIKOU3,--運転者指示事項３
	   ''                                    AS CONTENA_SHURUI_CD,--コンテナ種類CD,
	   ''                                    AS CONTENA_SHURUI_NAME,--コンテナ種類,
	   ''                                    AS CONTENA_JOUKYOU_NAME,--設置・引揚,
	   null                                    AS DAISUU,--台数,
	   TUSKD.HINMEI_CD,--品名CD,
	   TUSKD.HINMEI_NAME,--品名,
	   TUSKD.SUURYOU,--数量,
	   MU.UNIT_NAME_RYAKU AS UNIT_NAME--単位

FROM T_UKETSUKE_SK_ENTRY AS TUSKE                                                 --受付（出荷）入力テーブル
     LEFT JOIN M_MANIFEST_SHURUI AS MMS                                           --マニフェスト種類マスタ
         ON TUSKE.MANIFEST_SHURUI_CD = MMS.MANIFEST_SHURUI_CD
	 LEFT JOIN M_MANIFEST_TEHAI  AS MMT                                           --マニフェスト手配
	     ON TUSKE.MANIFEST_TEHAI_CD = MMT.MANIFEST_TEHAI_CD
	 LEFT JOIN M_GENBA AS MG1                                                     --現場マスタ 現場住所
	     ON TUSKE.GENBA_CD = MG1.GENBA_CD AND TUSKE.GYOUSHA_CD = MG1.GYOUSHA_CD
     LEFT JOIN M_GENBA AS MG2                                                     --現場マスタ 荷降先住所
	     ON TUSKE.NIZUMI_GYOUSHA_CD = MG2.GYOUSHA_CD AND TUSKE.NIZUMI_GENBA_CD  = MG2.GENBA_CD
     LEFT JOIN T_UKETSUKE_SK_DETAIL AS TUSKD                                      --受付（収集）明細
	     ON TUSKE.SYSTEM_ID = TUSKD.SYSTEM_ID AND TUSKE.SEQ = TUSKD.SEQ
	 LEFT JOIN M_UNIT AS MU                                                       --単位マスタ
	     ON TUSKD.UNIT_CD = MU.UNIT_CD
WHERE TUSKE.DELETE_FLG = 0
      AND TUSKE.SAGYOU_DATE >= /*data.kikanFrom*/
      AND TUSKE.SAGYOU_DATE <= /*data.kikanTo*/
	  AND TUSKE.UNTENSHA_CD >= /*data.untenshaFrom*/
      AND TUSKE.UNTENSHA_CD <= /*data.untenshaTo*/
--出荷End

ORDER BY SORT_SAGYOU_DATE, UNTENSHA_CD, SYUBETUCD, UKETSUKE_NUMBER